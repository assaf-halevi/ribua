<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">

<meta name="viewport"
      content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=no">

<title>Points Game</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
html, body {
    margin: 0;
    padding: 0;
    background: #cfcfcf;
    width: 100%;
    height: 100%;
    overflow: hidden;
    touch-action: none;
}

canvas { display: block; }

/* ריבוע */
#squareBtn {
    position: fixed;
    top: 12px;
    right: 12px;
    width: 22px;
    height: 22px;
    border: 2px solid #7d7d7d;
    background: #cfcfcf;
    z-index: 20;
}

/* כוכב */
#starBtn {
    position: fixed;
    top: 12px;
    right: 48px;
    width: 22px;
    height: 22px;
    z-index: 20;
}
#starBtn::before {
    content: "";
    position: absolute;
    inset: 0;
    background: #7d7d7d;
    clip-path: polygon(
        50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%,
        50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%
    );
}

/* יציאה */
#exitZone {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 40px;
    height: 40px;
    z-index: 50;
}
</style>
</head>
<body>

<div id="starBtn"></div>
<div id="squareBtn"></div>
<div id="exitZone"></div>
<canvas id="canvas"></canvas>

<script>
/* ================= Fullscreen ================= */
function enterFullscreen() {
    const el = document.documentElement;
    if (el.requestFullscreen) el.requestFullscreen();
    else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
}
document.addEventListener("click", () => {
    if (!document.fullscreenElement) enterFullscreen();
});

/* יציאה */
let exitTapTime = 0;
exitZone.addEventListener("touchstart", () => {
    const now = Date.now();
    if (now - exitTapTime < 400) document.exitFullscreen();
    exitTapTime = now;
});

/* ================= Canvas ================= */
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

function resize() {
    canvas.width = innerWidth;
    canvas.height = innerHeight;
}
resize();
addEventListener("resize", resize);

/* ================= עיצוב ================= */
const LINE_COLOR = "#8a8a8a";
const POINT_COLOR = "#7d7d7d";
const LINE_WIDTH = 3;
const POINT_RADIUS = 10;
const MAGNET_RADIUS = 80;

/* ================= נקודות ================= */
let points = [
    { x: 200, y: 150 },
    { x: 360, y: 280 },
    { x: 300, y: 520 },
    { x: 140, y: 300 }
];

let activePoint = null;

/* ================= Helpers ================= */
const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
const dist = (a,b)=>Math.hypot(a.x-b.x,a.y-b.y);
const touchPos = e => ({ x:e.touches[0].clientX, y:e.touches[0].clientY });

function getClosestPoint(pos) {
    let best=null, bestD=Infinity;
    points.forEach(p=>{
        const d=dist(p,pos);
        if(d<bestD){bestD=d;best=p;}
    });
    return bestD<=MAGNET_RADIUS?best:null;
}

/* ================= לולאה לפי שכנים ================= */
function reorderPointsNearestLoop(pts) {
    if (pts.length <= 2) return pts;

    const unused=[...pts];
    const ordered=[];

    unused.sort((a,b)=>a.x-b.x||a.y-b.y);
    let current=unused.shift();
    ordered.push(current);

    while(unused.length){
        let bi=0, bd=Infinity;
        unused.forEach((p,i)=>{
            const d=dist(current,p);
            if(d<bd){bd=d;bi=i;}
        });
        current=unused.splice(bi,1)[0];
        ordered.push(current);
    }
    return ordered;
}

/* ================= ציור ================= */
function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    ctx.strokeStyle=LINE_COLOR;
    ctx.lineWidth=LINE_WIDTH;
    ctx.beginPath();
    points.forEach((p,i)=>i?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y));
    ctx.closePath();
    ctx.stroke();

    ctx.fillStyle=POINT_COLOR;
    points.forEach(p=>{
        ctx.beginPath();
        ctx.arc(p.x,p.y,POINT_RADIUS,0,Math.PI*2);
        ctx.fill();
    });
}
draw();

/* ================= Touch ================= */
canvas.addEventListener("touchstart",e=>{
    activePoint=getClosestPoint(touchPos(e));
});

canvas.addEventListener("touchmove",e=>{
    if(!activePoint) return;

    const pos=touchPos(e);
    activePoint.x=clamp(pos.x,POINT_RADIUS,canvas.width-POINT_RADIUS);
    activePoint.y=clamp(pos.y,POINT_RADIUS,canvas.height-POINT_RADIUS);

    points=reorderPointsNearestLoop(points);
    draw();
});

canvas.addEventListener("touchend",()=>{
    if(activePoint){
        // ✅ חישוב סופי בעת הנחה
        points=reorderPointsNearestLoop(points);
        draw();
    }
    activePoint=null;
});

/* ================= צורות ================= */
squareBtn.onclick=makeSquare;
starBtn.onclick=makeStar;

function makeSquare(){
    const s=Math.min(canvas.width,canvas.height)*0.4;
    const cx=canvas.width/2, cy=canvas.height/2, h=s/2;
    points=[
        {x:cx-h,y:cy-h},{x:cx+h,y:cy-h},
        {x:cx+h,y:cy+h},{x:cx-h,y:cy+h}
    ];
    draw();
}

function makeStar(){
    const cx=canvas.width/2, cy=canvas.height/2;
    const R=Math.min(canvas.width,canvas.height)*0.35;
    const r=R*0.45;
    points=[];
    let a=-Math.PI/2;
    for(let i=0;i<5;i++){
        points.push({x:cx+Math.cos(a)*R,y:cy+Math.sin(a)*R});
        a+=Math.PI/5;
        points.push({x:cx+Math.cos(a)*r,y:cy+Math.sin(a)*r});
        a+=Math.PI/5;
    }
    draw();
}
</script>

</body>
</html>
